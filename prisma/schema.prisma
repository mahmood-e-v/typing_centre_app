generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client_v2"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Company {
  id                  String            @id @default(cuid())
  name                String            @unique
  code                String            @unique
  email               String?
  phone               String?
  address             String?
  trn                 String?
  isActive            Boolean           @default(true)
  lockedUntil         DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  accountingMethod    AccountingMethod  @default(ACCRUAL)
  accountingModel     AccountingModel   @default(CONSOLIDATED)
  allowBackDated      Boolean           @default(false)
  auditRetentionDays  Int               @default(1825)
  baseCurrency        String            @default("AED")
  decimalPrecision    Int               @default(2)
  emirate             Emirate           @default(DUBAI)
  establishmentCard   String?
  fiscalYearStart     Int               @default(1)
  invoiceFooter       String?
  invoiceHeader       String?
  legalType           LegalType         @default(SOLE_ESTABLISHMENT)
  logo                String?
  nameAr              String?
  stampImage          String?
  startDate           DateTime          @default(now())
  tradeLicense        String?
  vatFilingStart      DateTime?
  vatRate             Float             @default(5.0)
  vatRegistered       Boolean           @default(false)
  vatRegistrationDate DateTime?
  vatReturnFreq       VatFrequency      @default(QUARTERLY)
  website             String?
  accounts            Account[]
  auditLogs           AuditLog[]
  beneficiaries       Beneficiary[]
  branches            Branch[]
  dailyClosings       DailyClosing[]
  expenses            Expense[]
  expenseCategories   ExpenseCategory[]
  financialPeriods    FinancialPeriod[]
  invoices            Invoice[]
  journalEntries      JournalEntry[]
  partners            Partner[]
  transactions        Transaction[]
  users               User[]
  vendors             Vendor[]
  vouchers            Voucher[]
  voucherPayments     VoucherPayment[]
  workTypes           WorkType[]
  businessCards       BusinessCard[]
  quotations          Quotation[]
}

model DailyClosing {
  id          String        @id @default(cuid())
  companyId   String
  branchId    String
  date        DateTime
  status      ClosingStatus @default(OPEN)
  openingCash Decimal       @default(0) @db.Decimal(18, 2)
  cashIn      Decimal       @default(0) @db.Decimal(18, 2)
  cashOut     Decimal       @default(0) @db.Decimal(18, 2)
  closingCash Decimal       @default(0) @db.Decimal(18, 2)
  bankIn      Decimal       @default(0) @db.Decimal(18, 2)
  posIn       Decimal       @default(0) @db.Decimal(18, 2)
  totalSales  Decimal       @default(0) @db.Decimal(18, 2)
  totalVat    Decimal       @default(0) @db.Decimal(18, 2)
  totalGovFee Decimal       @default(0) @db.Decimal(18, 2)
  closedById  String?
  closedAt    DateTime?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  branch      Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  closedBy    User?         @relation(fields: [closedById], references: [id])
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, branchId, date])
  @@index([companyId])
  @@index([branchId])
  @@index([date])
}

model Branch {
  id                 String              @id @default(cuid())
  companyId          String
  name               String
  code               String
  location           String?
  phone              String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  address            String?
  allowCrossBranch   Boolean             @default(false)
  cashCounterEnabled Boolean             @default(true)
  email              String?
  emirate            Emirate             @default(DUBAI)
  googleMapLink      String?
  invoicePrefix      String?
  managerId          String?
  nextInvoiceNumber  Int                 @default(1)
  openingCashBalance Float               @default(0)
  receiptPrefix      String?
  separateNumbering  Boolean             @default(true)
  type               BranchType          @default(SUB)
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager            User?               @relation("BranchManager", fields: [managerId], references: [id])
  dailyClosings      DailyClosing[]
  expenses           Expense[]
  invoices           Invoice[]
  journalEntries     JournalEntry[]
  ledgerTransactions LedgerTransaction[]
  transactions       Transaction[]
  users              User[]              @relation("BranchUsers")
  vouchers           Voucher[]
  quotations         Quotation[]

  @@unique([companyId, code])
  @@index([companyId])
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String           @unique
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  userRoles   UserRole[]
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  module      String
  action      String
  description String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@unique([module, action])
  @@index([module])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model User {
  id                      String               @id @default(cuid())
  email                   String               @unique
  username                String               @unique
  password                String
  firstName               String?
  lastName                String?
  phone                   String?
  companyId               String
  branchId                String?
  role                    UserRole_Legacy      @default(EMPLOYEE)
  isActive                Boolean              @default(true)
  forcePasswordChange     Boolean              @default(false)
  lastLoginAt             DateTime?
  lastLoginIp             String?
  lastLoginUserAgent      String?
  passwordChangedAt       DateTime?
  failedLoginAttempts     Int                  @default(0)
  failedLoginResetAt      DateTime?
  lockedUntil             DateTime?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  approvalActions         ApprovalRequest[]    @relation("Approver")
  approvalRequests        ApprovalRequest[]    @relation("Requester")
  auditLogs               AuditLog[]
  managedBranches         Branch[]             @relation("BranchManager")
  dailyClosings           DailyClosing[]
  expenses                Expense[]
  accountingLockedPeriods FinancialPeriod[]    @relation("AccountingLock")
  unlockedPeriods         FinancialPeriod[]    @relation("PeriodUnlock")
  vatLockedPeriods        FinancialPeriod[]    @relation("VATLock")
  yearEndClosedPeriods    FinancialPeriod[]    @relation("YearEndClose")
  invoices                Invoice[]
  passwordResetTokens     PasswordResetToken[]
  sessions                Session[]
  transactions            Transaction[]
  branch                  Branch?              @relation("BranchUsers", fields: [branchId], references: [id])
  company                 Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userRoles               UserRole[]
  vouchers                Voucher[]
  voucherPayments         VoucherPayment[]
  quotations              Quotation[]
  approvedQuotations      Quotation[]          @relation("QuotationApprover")

  @@index([companyId])
  @@index([branchId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  isValid      Boolean  @default(true)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  userId     String?
  action     String
  module     String
  recordId   String?
  recordType String?
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([module])
  @@index([timestamp])
}

model ApprovalRequest {
  id          String         @id @default(cuid())
  requesterId String
  approverId  String?
  module      String
  action      String
  recordId    String
  recordType  String
  reason      String
  status      ApprovalStatus @default(PENDING)
  approvedAt  DateTime?
  rejectedAt  DateTime?
  comments    String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  approver    User?          @relation("Approver", fields: [approverId], references: [id])
  requester   User           @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([requesterId])
  @@index([approverId])
  @@index([status])
}

model FinancialPeriod {
  id                   String    @id @default(cuid())
  companyId            String
  year                 Int
  month                Int
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  accountingLocked     Boolean   @default(false)
  accountingLockedAt   DateTime?
  accountingLockedById String?
  isYearEndClosed      Boolean   @default(false)
  lastUnlockReason     String?
  lastUnlockedAt       DateTime?
  lastUnlockedById     String?
  periodEnd            DateTime
  periodStart          DateTime
  vatLocked            Boolean   @default(false)
  vatLockedAt          DateTime?
  vatLockedById        String?
  yearEndClosedAt      DateTime?
  yearEndClosedById    String?
  accountingLockedBy   User?     @relation("AccountingLock", fields: [accountingLockedById], references: [id])
  company              Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lastUnlockedBy       User?     @relation("PeriodUnlock", fields: [lastUnlockedById], references: [id])
  vatLockedBy          User?     @relation("VATLock", fields: [vatLockedById], references: [id])
  yearEndClosedBy      User?     @relation("YearEndClose", fields: [yearEndClosedById], references: [id])

  @@unique([companyId, year, month])
  @@index([companyId])
  @@index([accountingLocked])
  @@index([vatLocked])
  @@index([periodStart])
  @@index([periodEnd])
}

model Invoice {
  id               String        @id @default(cuid())
  invoiceNo        String        @unique
  date             DateTime      @default(now())
  companyId        String
  branchId         String?
  customerId       String?
  customerName     String?
  agentId          String?
  subtotal         Decimal       @default(0) @db.Decimal(18, 2)
  tax              Decimal       @default(0) @db.Decimal(18, 2)
  discount         Decimal       @default(0) @db.Decimal(18, 2)
  total            Decimal       @default(0) @db.Decimal(18, 2)
  paidAmount       Decimal       @default(0) @db.Decimal(18, 2)
  balance          Decimal       @default(0) @db.Decimal(18, 2)
  paymentMethod    PaymentMethod @default(CASH)
  paymentRef       String?
  bankName         String?
  status           InvoiceStatus @default(DRAFT)
  govtFeeAccountId String?
  govtFeeRef       String?
  customerPhone    String?
  customerEmail    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  agent            User?         @relation(fields: [agentId], references: [id])
  branch           Branch?       @relation(fields: [branchId], references: [id])
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  govtFeeAccount   Account?      @relation("InvoiceGovtFee", fields: [govtFeeAccountId], references: [id])
  transactions     Transaction[]
  
  // Link to Quotation
  quotationId       String?
  quotation         Quotation?      @relation(fields: [quotationId], references: [id])
  
  @@index([companyId])
  @@index([branchId])
  @@index([invoiceNo])
}

model Transaction {
  id               String          @id @default(cuid())
  companyId        String
  branchId         String?
  invoiceId        String?
  invNo            String?
  date             DateTime        @default(now())
  enteredById      String?
  beneficiaryId    String?
  partnerId        String?
  workTypeId       String?
  govFee           Decimal         @default(0) @db.Decimal(18, 2)
  typingCharge     Decimal         @default(0) @db.Decimal(18, 2)
  vat              Decimal         @default(0) @db.Decimal(18, 2)
  total            Decimal         @default(0) @db.Decimal(18, 2)
  type             TransactionType @default(SERVICE)
  receiptNo        String?
  govtFeeAccountId String?
  govtFeeRef       String?
  paymentMethod    PaymentMethod
  cardId           String?
  transactionId    String?
  status           PaymentStatus   @default(NOT_PAID)
  advanceStatus    AdvanceStatus   @default(NONE)
  advanceAmount    Decimal         @default(0) @db.Decimal(18, 2)
  customerName     String?
  applicantName    String?
  details          String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  isVatApplicable  Boolean         @default(true)
  vatRate          Decimal         @default(5) @db.Decimal(18, 2)
  beneficiary      Beneficiary?    @relation(fields: [beneficiaryId], references: [id])
  branch           Branch?         @relation(fields: [branchId], references: [id])
  account          Account?        @relation(fields: [cardId], references: [id])
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enteredBy        User?           @relation(fields: [enteredById], references: [id])
  govtFeeAccount   Account?        @relation("TransactionGovtFee", fields: [govtFeeAccountId], references: [id])
  invoice          Invoice?        @relation(fields: [invoiceId], references: [id])
  partner          Partner?        @relation(fields: [partnerId], references: [id])
  workType         WorkType?       @relation(fields: [workTypeId], references: [id])
  quantity         Int             @default(1)

  @@index([companyId])
  @@index([branchId])
  @@index([invoiceId])
}

model WorkType {
  id                 String        @id @default(cuid())
  companyId          String
  description        String
  presetGovFee       Decimal       @default(0) @db.Decimal(18, 2)
  presetTypingCharge Decimal       @default(0) @db.Decimal(18, 2)
  vatApplicable      Boolean       @default(true)
  vatRate            Decimal       @default(5) @db.Decimal(18, 2)
  transactions       Transaction[]
  quotationItems     QuotationItem[]
  company            Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, description])
  @@index([companyId])
}

model Beneficiary {
  id           String        @id @default(cuid())
  companyId    String
  name         String
  details      String?
  phone        String?
  email        String?
  partnerId    String?
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  partner      Partner?      @relation(fields: [partnerId], references: [id])
  transactions Transaction[]

  @@index([companyId])
}

model Partner {
  id                 String              @id @default(cuid())
  companyId          String
  name               String
  type               PartnerType
  email              String?
  phone              String?
  beneficiaries      Beneficiary[]
  ledgerTransactions LedgerTransaction[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
  quotations         Quotation[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Expense {
  id            String          @id @default(cuid())
  companyId     String
  branchId      String?
  date          DateTime        @default(now())
  description   String?
  amount        Decimal         @db.Decimal(18, 2)
  categoryId    String
  paymentMethod PaymentMethod
  accountId     String?
  enteredById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  account       Account?        @relation(fields: [accountId], references: [id])
  branch        Branch?         @relation(fields: [branchId], references: [id])
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enteredBy     User            @relation(fields: [enteredById], references: [id])

  @@index([companyId])
  @@index([branchId])
}

model ExpenseCategory {
  id              String        @id @default(cuid())
  companyId       String
  name            String
  description     String?
  ledgerAccountId String?
  expenses        Expense[]
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ledgerAccount   Account?      @relation("CategoryAccount", fields: [ledgerAccountId], references: [id])
  voucherItems    VoucherItem[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Account {
  id                  String              @id @default(cuid())
  companyId           String
  name                String
  type                AccountType
  balance             Decimal             @default(0) @db.Decimal(18, 2)
  accountNumber       String?
  bankName            String?
  branchId            String?
  category            AccountCategory
  code                String
  iban                String?
  isPostable          Boolean             @default(true)
  isSystem            Boolean             @default(false)
  linkedBranchIds     String[]            @default([])
  merchantId          String?
  parentAccountId     String?
  swiftCode           String?
  terminalId          String?
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parentAccount       Account?            @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  childAccounts       Account[]           @relation("AccountHierarchy")
  expenses            Expense[]
  expenseCategories   ExpenseCategory[]   @relation("CategoryAccount")
  invoicesGovtFee     Invoice[]           @relation("InvoiceGovtFee")
  ledgerTransactions  LedgerTransaction[]
  transactions        Transaction[]
  transactionsGovtFee Transaction[]       @relation("TransactionGovtFee")
  vouchers            Voucher[]
  voucherPayments     VoucherPayment[]
  businessCards       BusinessCard[]

  @@unique([companyId, code])
  @@index([companyId])
}

model JournalEntry {
  id              String              @id @default(cuid())
  companyId       String
  branchId        String?
  postingDate     DateTime            @default(now())
  createdAt       DateTime            @default(now())
  description     String?
  type            JournalEntryType
  referenceType   String?
  referenceId     String?
  reversedEntryId String?
  branch          Branch?             @relation(fields: [branchId], references: [id])
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions    LedgerTransaction[]

  @@index([companyId])
  @@index([branchId])
}

model LedgerTransaction {
  id             String       @id @default(cuid())
  journalEntryId String
  accountId      String
  debit          Decimal      @default(0) @db.Decimal(18, 2)
  credit         Decimal      @default(0) @db.Decimal(18, 2)
  partnerId      String?
  companyId      String
  branchId       String?
  account        Account      @relation(fields: [accountId], references: [id])
  branch         Branch?      @relation(fields: [branchId], references: [id])
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  partner        Partner?     @relation(fields: [partnerId], references: [id])
  cardId         String?
  card           BusinessCard?  @relation(fields: [cardId], references: [id])

  @@index([companyId])
  @@index([branchId])
  @@index([accountId])
}

model Voucher {
  id            String           @id @default(cuid())
  voucherNo     String           @unique
  date          DateTime         @default(now())
  companyId     String
  branchId      String?
  description   String?
  vendorId      String?
  vendorName    String?
  total         Decimal          @default(0) @db.Decimal(18, 2)
  paidAmount    Decimal          @default(0) @db.Decimal(18, 2)
  balance       Decimal          @default(0) @db.Decimal(18, 2)
  status        VoucherStatus    @default(OPEN)
  type          VoucherType      @default(PAYMENT)
  paymentMethod PaymentMethod    @default(CASH)
  accountId     String?
  enteredById   String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  account       Account?         @relation(fields: [accountId], references: [id])
  branch        Branch?          @relation(fields: [branchId], references: [id])
  company       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enteredBy     User             @relation(fields: [enteredById], references: [id])
  vendor        Vendor?          @relation(fields: [vendorId], references: [id])
  items         VoucherItem[]
  payments      VoucherPayment[]
  billUrl       String?

  @@index([companyId])
  @@index([branchId])
}

model VoucherItem {
  id              String          @id @default(cuid())
  voucherId       String
  categoryId      String
  quantity        Int             @default(1)
  amount          Decimal         @db.Decimal(18, 2)
  description     String?
  isVatApplicable Boolean         @default(true)
  vatAmount       Decimal         @default(0) @db.Decimal(18, 2)
  vatRate         Decimal         @default(5) @db.Decimal(18, 2)
  category        ExpenseCategory @relation(fields: [categoryId], references: [id])
  voucher         Voucher         @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

model Vendor {
  id        String    @id @default(cuid())
  companyId String
  name      String
  phone     String?
  email     String?
  address   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vouchers  Voucher[]

  @@unique([companyId, name])
  @@index([companyId])
}

model VoucherPayment {
  id            String        @id @default(cuid())
  voucherId     String
  date          DateTime      @default(now())
  amount        Decimal       @db.Decimal(18, 2)
  paymentMethod PaymentMethod
  accountId     String?
  receiptNo     String
  enteredById   String
  createdAt     DateTime      @default(now())
  companyId     String
  account       Account?      @relation(fields: [accountId], references: [id])
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enteredBy     User          @relation(fields: [enteredById], references: [id])
  voucher       Voucher       @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@unique([companyId, receiptNo])
  @@index([companyId])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

enum ClosingStatus {
  OPEN
  CLOSED
}

enum LegalType {
  SOLE_ESTABLISHMENT
  LLC
  CIVIL_COMPANY
  FREEZONE_ENTITY
  BRANCH_OF_FOREIGN
}

enum Emirate {
  DUBAI
  ABU_DHABI
  SHARJAH
  AJMAN
  UMM_AL_QUWAIN
  RAS_AL_KHAIMAH
  FUJAIRAH
}

enum VatFrequency {
  MONTHLY
  QUARTERLY
}

enum AccountingMethod {
  ACCRUAL
  CASH
}

enum AccountingModel {
  CONSOLIDATED
  BRANCH_WISE
}

enum BranchType {
  MAIN
  SUB
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum UserRole_Legacy {
  ADMIN
  EMPLOYEE
  BRANCH_MANAGER
  OWNER
  SUPER_ADMIN
}

enum TransactionType {
  SERVICE
  PAYMENT
  OPENING_BALANCE
}

enum AccountCategory {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum JournalEntryType {
  INVOICE
  PAYMENT
  EXPENSE
  GOVT_FEE
  ADJUSTMENT
  REVERSAL
}

enum PaymentMethod {
  CASH
  CARD
  ONLINE
  WALLET
}

enum PaymentStatus {
  PAID
  NOT_PAID
  PARTIAL
}

enum AdvanceStatus {
  NONE
  PARTIAL
  FULL
}

enum AccountType {
  CASH
  BANK
  CREDIT_CARD
}

enum PartnerType {
  PRO
  CORPORATE
  INDIVIDUAL
}

enum VoucherStatus {
  DRAFT
  OPEN
  PAID
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PAID
  PARTIAL
  CANCELLED
}

enum CardType {
  CREDIT
  DEBIT
}

model BusinessCard {
  id                  String              @id @default(cuid())
  companyId           String
  name                String
  type                CardType            @default(CREDIT)
  issuingBank         String
  last4Digits         String
  creditLimit         Decimal?            @db.Decimal(18, 2)
  currency            String              @default("AED")
  statementCycleDay   Int? // Only for Credit
  paymentDueDays      Int? // Only for Credit
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  // Ledger Link
  ledgerAccountId     String
  ledgerAccount       Account             @relation(fields: [ledgerAccountId], references: [id])
  
  // Relations
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  ledgerTransactions  LedgerTransaction[]

  @@unique([companyId, ledgerAccountId]) // One card per account link usually, but can be relaxed if needed
  @@index([companyId])
}


enum VoucherType {
  PAYMENT
  RECEIPT
}

// QUOTATION SYSTEM MODELS

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
  CONVERTED
  PARTIALLY_INVOICED
}

model Quotation {
  id              String          @id @default(cuid())
  quotationNo     String          @unique
  date            DateTime        @default(now())
  validUntil      DateTime
  companyId       String
  branchId        String?
  partnerId       String?         // Customer
  beneficiaryName String?         // Optional: Specific beneficiary name if different from partner
  salespersonId   String
  currency        String          @default("AED")
  status          QuotationStatus @default(DRAFT)
  
  subtotal        Decimal         @default(0) @db.Decimal(18, 2)
  totalGovFee     Decimal         @default(0) @db.Decimal(18, 2)
  totalTax        Decimal         @default(0) @db.Decimal(18, 2)
  grandTotal      Decimal         @default(0) @db.Decimal(18, 2)
  
  notes           String?
  termsAndConditions String?      // Snapshot of terms at time of creation
  
  // Tracking
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  sentAt          DateTime?
  acceptedAt      DateTime?
  convertedAt     DateTime?
  
  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch          Branch?         @relation(fields: [branchId], references: [id])
  partner         Partner?        @relation(fields: [partnerId], references: [id])
  salesperson     User            @relation(fields: [salespersonId], references: [id])
  items           QuotationItem[]
  invoices        Invoice[]       // One or more invoices generated from this quotation
  
  // Approval
  approvedById    String?
  approvedAt      DateTime?
  approvedBy      User?           @relation("QuotationApprover", fields: [approvedById], references: [id])
  
  // Partial Conversion & Soft Delete
  invoicedAmount  Decimal         @default(0) @db.Decimal(18, 2)
  deletedAt       DateTime?       // Soft delete
  
  @@index([companyId])
  @@index([quotationNo])
  @@index([partnerId])
  @@index([status])
}

model QuotationItem {
  id              String      @id @default(cuid())
  quotationId     String
  workTypeId      String?     // Link to Service/WorkType
  description     String
  
  govFee          Decimal     @default(0) @db.Decimal(18, 2)
  typingCharge    Decimal     @default(0) @db.Decimal(18, 2)
  taxRate         Decimal     @default(5.0) @db.Decimal(5, 2)
  taxAmount       Decimal     @default(0) @db.Decimal(18, 2)
  total           Decimal     @default(0) @db.Decimal(18, 2)
  isVatApplicable Boolean     @default(true)
  
  // Relations
  quotation       Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  workType        WorkType?   @relation(fields: [workTypeId], references: [id])
  quantity        Int         @default(1)
  
  @@index([quotationId])
}
